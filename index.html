<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" href="style.css">

        <!-- include A-Frame -->
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <!-- include Ar.js for A-Frame -->
        <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.js"></script>
        <!-- include A-Frame extras (animation-mixer) -->
        <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>

        <script src="models.js"></script>
        <script src="userState.js"></script>
        <script src="interaction.js"></script>
        
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/css/index.css">

        <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
        <script>
            AFRAME.registerComponent("controller", {
                init: function () {
                    this.modelVisible = false;
                    // track markerFound/markerLost
                    this.el.addEventListener("markerFound", () => this.modelVisible = true);
                    this.el.addEventListener("markerLost", () => this.modelVisible = false);
                    // grab the model reference
                    document.querySelector("[gltf-model]").addEventListener("model-loaded", evt => {
                        this.mesh = evt.detail.model
                    })
                    // hammerjs input helper
                    const hammertime = new Hammer(document.body);
         
                    // rotation
                    // pan left/right for rotation
                    this.isPanning = false;
                    hammertime.on("panleft", () => {
                        if (!this.modelVisible) return;
                        this.isPanning = true
                        this.mesh.rotation.y -= 4 * Math.PI / 360;
                    })
                   
                    hammertime.on("panright", () => {
                        if (!this.modelVisible) return;
                        this.isPanning = true
                        this.mesh.rotation.y += 4 * Math.PI / 360;
                    })
                    hammertime.on("panend", () => this.isPanning = false)
                    hammertime.on("pancancel", () => this.isPanning = false)
    
                    hammertime.on("swipeleft",  ({velocity}) => {
                        if (!this.modelVisible) return;
                        this.swipeVelocity = velocity
                    })
                    hammertime.on("swiperight", ({velocity}) => {
                        if (!this.modelVisible) return;
                        this.swipeVelocity = velocity
                    })
                },
                tick: function() {
                    if (!(this.modelVisible && this.swipeVelocity &&!this.isPanning)) return;
                    this.mesh.rotation.y += this.swipeVelocity * 4 * Math.PI / 360;
                    this.swipeVelocity *= 0.93;
                    if (Math.abs(this.swipeVelocity) <= 0.1) this.swipeVelocity = 0;
                }
            })
        </script>
    </head>

    <body>  
        <div class='speech-bubble'></div>
        <div>
            <button class="button">show/hide keyboard</button>
            <input class="input" placeholder="Type your answer" style="display: none;"/>
            <div class="simple-keyboard" style="display: none;"></div>
            <button class="confirmBtn" style="display: none;">Confirm</button>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/simple-keyboard@latest/build/index.js"></script>
        <script src="index.js"></script>

        <a-scene id="scene" embedded vr-mode-ui="enabled: false" arjs="debugUIEnabled: false" cursor="rayOrigin: mouse" accepts-clicks>
            <a-assets>
                <a-asset-item id="CooWithoutVR" src="cooWithoutVR.gltf"></a-asset-item> 
                <a-asset-item id="CooWithVR" src="cooWithVR.gltf"></a-asset-item>
            </a-assets>
            <a-marker id="pyra-marker" type="pattern" url="./pattern-Waving.patt" smooth="true">
                <a-entity id="pyra" gltf-model="#CooWithoutVR" rotation="-90 0 0" position="0 0 0.5" scale="0.3 0.3 0.3" animation-mixer="clip: Waving; timeScale: 1"></a-entity>
            </a-marker> 
            <a-marker type="pattern" url="./pattern-Bored.patt">
                <a-entity gltf-model="#CooWithoutVR" rotation="-90 0 0" position="0 0 0.5" scale="0.3 0.3 0.3" animation-mixer="clip: Bored Idle"></a-entity>
            </a-marker>
            <a-marker type="pattern" url="./pattern-Jump.patt">
                <a-entity gltf-model="#CooWithoutVR" rotation="-90 0 0" position="0 0 0.5" scale="0.3 0.3 0.3" animation-mixer="clip: Jump"></a-entity>
            </a-marker>
            <a-marker type="pattern" url="./pattern-Dance.patt">
                <a-entity gltf-model="#CooWithoutVR" rotation="-90 0 0" position="0 0 0.5" scale="0.3 0.3 0.3" animation-mixer="clip: Floss Dance"></a-entity>
            </a-marker>
            <a-marker type="pattern" url="./pattern-VR.patt">
                <a-entity gltf-model="#CooWithVR" rotation="-90 0 0" position="0 0 0.5" scale="0.3 0.3 0.3" animation-mixer="clip: VR"></a-entity>
            </a-marker>
            <a-entity camera></a-entity>
        </a-scene>
    </body>
</html>
